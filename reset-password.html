<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Gerenciador Financeiro - Redefinir senha">
  <meta name="theme-color" content="#f8fafc">
  <meta name="color-scheme" content="light dark">
  <title>Redefinir Senha - Gerenciador Financeiro</title>
  
  <!-- Preload Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Supabase Client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body class="auth-page">
  <!-- Background Decorations -->
  <div class="auth-bg">
    <div class="auth-bg__shape auth-bg__shape--1"></div>
    <div class="auth-bg__shape auth-bg__shape--2"></div>
    <div class="auth-bg__shape auth-bg__shape--3"></div>
  </div>

  <!-- Main Container -->
  <main class="auth-container auth-container--single">
    <section class="auth-forms auth-forms--centered">
      <!-- Theme Toggle -->
      <button class="theme-toggle theme-toggle--auth" id="theme-toggle" aria-label="Alternar tema">
        <span class="theme-toggle__track"></span>
        <span class="theme-toggle__thumb">
          <span class="theme-toggle__icon theme-toggle__icon--sun">‚òÄÔ∏è</span>
          <span class="theme-toggle__icon theme-toggle__icon--moon">üåô</span>
        </span>
      </button>

      <!-- Reset Password Form -->
      <div class="auth-card" id="reset-card">
        <div class="auth-card__header">
          <div class="auth-branding__logo" style="margin: 0 auto var(--spacing-lg);">üí∞</div>
          <h2 class="auth-card__title">Redefinir senha</h2>
          <p class="auth-card__subtitle">Digite sua nova senha abaixo</p>
        </div>

        <form class="auth-form" id="reset-form">
          <div class="form-group">
            <label class="form-label" for="new-password">Nova senha</label>
            <div class="input-icon-wrapper">
              <span class="input-icon">üîí</span>
              <input 
                type="password" 
                class="form-input form-input--icon" 
                id="new-password" 
                name="password" 
                placeholder="M√≠nimo 6 caracteres" 
                required
                autocomplete="new-password"
                minlength="6"
              >
              <button type="button" class="password-toggle" id="new-password-toggle" aria-label="Mostrar senha">
                üëÅÔ∏è
              </button>
            </div>
            <div class="password-strength" id="password-strength">
              <div class="password-strength__bar"></div>
              <span class="password-strength__text"></span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="confirm-password">Confirmar nova senha</label>
            <div class="input-icon-wrapper">
              <span class="input-icon">üîí</span>
              <input 
                type="password" 
                class="form-input form-input--icon" 
                id="confirm-password" 
                name="confirm_password" 
                placeholder="Repita a nova senha" 
                required
                autocomplete="new-password"
                minlength="6"
              >
            </div>
          </div>

          <button type="submit" class="btn btn--primary btn--full btn--lg" id="reset-btn">
            <span class="btn__text">Redefinir senha</span>
            <span class="btn__loader" style="display: none;">‚è≥</span>
          </button>
        </form>

        <div class="auth-card__footer">
          <p><a href="login.html" class="auth-link">‚Üê Voltar para o login</a></p>
        </div>
      </div>

      <!-- Success Message -->
      <div class="auth-card auth-card--success" id="success-card" style="display: none;">
        <div class="auth-success">
          <div class="auth-success__icon">‚úÖ</div>
          <h2 class="auth-success__title">Senha redefinida!</h2>
          <p class="auth-success__message">
            Sua senha foi alterada com sucesso. Voc√™ j√° pode fazer login com a nova senha.
          </p>
          <a href="login.html" class="btn btn--primary btn--full">
            Ir para o login
          </a>
        </div>
      </div>

      <!-- Error Message -->
      <div class="auth-card" id="error-card" style="display: none;">
        <div class="auth-success">
          <div class="auth-success__icon">‚ùå</div>
          <h2 class="auth-success__title">Link inv√°lido</h2>
          <p class="auth-success__message">
            Este link de recupera√ß√£o √© inv√°lido ou expirou. Solicite um novo link de recupera√ß√£o.
          </p>
          <a href="login.html" class="btn btn--primary btn--full">
            Voltar para o login
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Script -->
  <script type="module">
    import { config } from './js/config.js';
    
    const { SUPABASE_URL, SUPABASE_ANON_KEY } = config;
    const THEME_STORAGE_KEY = 'gerenciador-financeiro-theme';
    
    // Supabase Client
    let supabase = null;
    
    if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
    
    // DOM Elements
    const dom = {
      resetCard: document.getElementById('reset-card'),
      successCard: document.getElementById('success-card'),
      errorCard: document.getElementById('error-card'),
      resetForm: document.getElementById('reset-form'),
      resetBtn: document.getElementById('reset-btn'),
      themeToggle: document.getElementById('theme-toggle'),
      passwordStrength: document.getElementById('password-strength'),
      toastContainer: document.getElementById('toast-container')
    };
    
    // Theme
    function getPreferredTheme() {
      const saved = localStorage.getItem(THEME_STORAGE_KEY);
      if (saved === 'light' || saved === 'dark') return saved;
      return window.matchMedia?.('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem(THEME_STORAGE_KEY, theme);
    }
    
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(current === 'light' ? 'dark' : 'light');
    }
    
    // Toast
    function showToast(message, type = 'info', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast toast--${type}`;
      toast.innerHTML = `
        <span class="toast__message">${message}</span>
        <button class="toast__close">‚úï</button>
      `;
      dom.toastContainer.appendChild(toast);
      toast.querySelector('.toast__close').addEventListener('click', () => toast.remove());
      setTimeout(() => toast.remove(), duration);
    }
    
    // Password Strength
    function checkPasswordStrength(password) {
      let score = 0;
      if (password.length >= 6) score++;
      if (password.length >= 8) score++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
      if (/\d/.test(password)) score++;
      if (/[^a-zA-Z0-9]/.test(password)) score++;
      return score;
    }
    
    function updatePasswordStrength(password) {
      const bar = dom.passwordStrength.querySelector('.password-strength__bar');
      const text = dom.passwordStrength.querySelector('.password-strength__text');
      
      if (!password) {
        dom.passwordStrength.style.display = 'none';
        return;
      }
      
      dom.passwordStrength.style.display = 'flex';
      const score = checkPasswordStrength(password);
      
      const levels = [
        { class: 'weak', text: 'Muito fraca', width: '20%' },
        { class: 'weak', text: 'Fraca', width: '40%' },
        { class: 'medium', text: 'M√©dia', width: '60%' },
        { class: 'good', text: 'Boa', width: '80%' },
        { class: 'strong', text: 'Forte', width: '100%' }
      ];
      
      const level = levels[Math.min(score, levels.length - 1)];
      bar.className = `password-strength__bar password-strength__bar--${level.class}`;
      bar.style.width = level.width;
      text.textContent = level.text;
      text.className = `password-strength__text password-strength__text--${level.class}`;
    }
    
    // Password Toggle
    function togglePasswordVisibility(inputId, btn) {
      const input = document.getElementById(inputId);
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      btn.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
    }
    
    // Show Card
    function showCard(card) {
      [dom.resetCard, dom.successCard, dom.errorCard].forEach(c => {
        if (c) c.style.display = 'none';
      });
      if (card) card.style.display = 'block';
    }
    
    // Reset Password Handler
    async function handleResetPassword(e) {
      e.preventDefault();
      
      const password = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (password.length < 6) {
        showToast('A senha deve ter pelo menos 6 caracteres', 'warning');
        return;
      }
      
      if (password !== confirmPassword) {
        showToast('As senhas n√£o coincidem', 'warning');
        return;
      }
      
      const textEl = dom.resetBtn.querySelector('.btn__text');
      const loaderEl = dom.resetBtn.querySelector('.btn__loader');
      
      dom.resetBtn.disabled = true;
      textEl.style.display = 'none';
      loaderEl.style.display = 'inline';
      
      try {
        const { error } = await supabase.auth.updateUser({ password });
        
        if (error) {
          showToast(`Erro: ${error.message}`, 'error');
          return;
        }
        
        showCard(dom.successCard);
        
      } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao redefinir senha', 'error');
      } finally {
        dom.resetBtn.disabled = false;
        textEl.style.display = 'inline';
        loaderEl.style.display = 'none';
      }
    }
    
    // Check if valid reset session
    async function checkSession() {
      if (!supabase) {
        showCard(dom.errorCard);
        return;
      }
      
      try {
        const { data: { session } } = await supabase.auth.getSession();
        
        // Se n√£o tem sess√£o v√°lida, mostra erro
        if (!session) {
          showCard(dom.errorCard);
        }
      } catch (error) {
        console.error('Erro ao verificar sess√£o:', error);
        showCard(dom.errorCard);
      }
    }
    
    // Initialize
    function init() {
      applyTheme(getPreferredTheme());
      
      dom.themeToggle?.addEventListener('click', toggleTheme);
      dom.resetForm?.addEventListener('submit', handleResetPassword);
      
      document.getElementById('new-password-toggle')?.addEventListener('click', function() {
        togglePasswordVisibility('new-password', this);
      });
      
      document.getElementById('new-password')?.addEventListener('input', function() {
        updatePasswordStrength(this.value);
      });
      
      // Verifica sess√£o
      checkSession();
    }
    
    init();
  </script>
</body>
</html>
